name: Generate Diziyou M3U

on:
  # SADECE manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in (PUSH TETÄ°KLEYÄ°CÄ°SÄ° YOK)
  workflow_dispatch:
    inputs:
      comment:
        description: 'Not (isteÄŸe baÄŸlÄ±)'
        required: false
        default: 'Manuel Ã§alÄ±ÅŸtÄ±rma'
  # Otomatik zamanlama (36 saatte bir)
  schedule:
    - cron: '0 */36 * * *'
  # PUSH TETÄ°KLEYÄ°CÄ°SÄ° YOK - kod kaydedince otomatik baÅŸlamaz

jobs:
  generate-m3u:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Optimize ile 15 dakika YETERLÄ°
    
    steps:
    - name: âœ… Repository'yi al
      uses: actions/checkout@v3
    
    - name: ğŸ Python 3.10 kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
      run: |
        pip install --upgrade pip
        pip install requests==2.31.0 beautifulsoup4==4.12.0
    
    - name: ğŸš€ M3U oluÅŸtur ve KONTROL ET
      id: generate
      run: |
        echo "=== DÄ°ZÄ°YOU M3U OLUÅTURUCU BAÅLATILIYOR ==="
        echo "Tarih: $(date)"
        echo "Commit: ${{ github.sha }}"
        echo ""
        
        # Script'i Ã§alÄ±ÅŸtÄ±r
        python diziyou_m3u.py
        
        echo ""
        echo "=== DOSYA OLUÅUM KONTROLÃœ ==="
        
        # KESÄ°NLÄ°KLE DOSYA VAR MI KONTROL
        if [ -f "diziyou.m3u" ]; then
          # Dosya bilgileri
          FILE_SIZE=$(wc -c < diziyou.m3u)
          LINES=$(wc -l < diziyou.m3u)
          echo "âœ… BAÅARILI: diziyou.m3u OLUÅTU"
          echo "ğŸ“ Boyut: $FILE_SIZE byte"
          echo "ğŸ“„ SatÄ±r sayÄ±sÄ±: $LINES"
          echo "ğŸ“ Yol: $(pwd)/diziyou.m3u"
          
          # Ä°lk 3 satÄ±rÄ± gÃ¶ster
          echo ""
          echo "=== Ä°LK 3 GÄ°RÄ°Å Ã–RNEÄÄ° ==="
          head -8 diziyou.m3u
          
          # Ã‡Ä±ktÄ± deÄŸiÅŸkenlerini ayarla
          echo "file_created=true" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ HATA: diziyou.m3u DOSYASI OLUÅMADI!"
          echo "Mevcut dosyalar:"
          ls -la
          echo "file_created=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ’¾ DEPOYA KESÄ°N KAYDET
      if: steps.generate.outputs.file_created == 'true'
      run: |
        echo "=== DEPOYA KAYDETME Ä°ÅLEMÄ° ==="
        
        # Git ayarlarÄ±
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # M3U dosyasÄ±nÄ± ekle
        git add diziyou.m3u
        
        # DeÄŸiÅŸiklik kontrolÃ¼
        if git diff --cached --quiet; then
          echo "â„¹ï¸  DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
        else
          # Commit mesajÄ±
          COMMIT_MSG="ğŸ¤– M3U gÃ¼ncellendi [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          # Commit yap
          git commit -m "$COMMIT_MSG"
          
          # Depoya gÃ¶nder
          echo "ğŸ”„ Depoya gÃ¶nderiliyor..."
          git push
          echo "âœ… DeÄŸiÅŸiklikler depoya kaydedildi"
        fi
    
    - name: ğŸ“Š SONUÃ‡ Ã–ZETÄ°
      if: always()
      run: |
        echo "=== Ä°ÅLEM SONUÃ‡ Ã–ZETÄ° ==="
        echo "Workflow: ${{ github.workflow }}"
        echo "Ã‡alÄ±ÅŸtÄ±rma ID: ${{ github.run_id }}"
        echo "Tarih: $(date)"
        
        if [ -f "diziyou.m3u" ]; then
          echo ""
          echo "ğŸ‰ BAÅARILI: M3U dosyasÄ± oluÅŸturuldu"
          echo "ğŸ“ $(pwd)/diziyou.m3u"
          echo "ğŸ“Š Boyut: $(wc -c < diziyou.m3u) byte"
          echo ""
          echo "Depodaki dosyaya eriÅŸmek iÃ§in:"
          echo "https://github.com/${{ github.repository }}/blob/main/diziyou.m3u"
        else
          echo ""
          echo "âŒ BAÅARISIZ: M3U dosyasÄ± oluÅŸturulamadÄ±"
          echo ""
          echo "Sorun giderme:"
          echo "1. 'M3U oluÅŸtur' adÄ±mÄ±nÄ±n Ã§Ä±ktÄ±larÄ±nÄ± kontrol edin"
          echo "2. Python script hatalarÄ±nÄ± kontrol edin"
          echo "3. Network baÄŸlantÄ±sÄ±nÄ± kontrol edin"
        fi
